parameters:
- name: BuildConfiguration
  displayName: Build Configuration
  type: string
  default: Debug
  values: [ 'Debug', 'Release' ]
- name: LangVersion
  displayName: C# Language Version
  type: string
  default: '6'
  values: [ '6', '7', '8', '9', '10', '11', '12', '13' ]
- name: FrameworkVersion
  displayName: .NET Framework Version
  type: string
  default: 'net472'
  values: [ 'net452', 'net46', 'net472' ]
- name: BuildSolution
  displayName: Solution
  type: string
  default: StyleCopAnalyzers.sln
- name: BuildPlatform
  displayName: Platform
  type: string
  default: Any CPU

jobs:
- job: Test_CSharp_${{ parameters.LangVersion }}
  displayName: Test C# ${{ parameters.LangVersion }}
  steps:
  - powershell: .\init.ps1 -NoRestore
    displayName: Install .NET Core SDK

  - task: NuGetToolInstaller@0
    displayName: 'Use NuGet 6.0.6'
    inputs:
      versionSpec: 6.0.6

  - task: DownloadPipelineArtifact@2
    displayName: 🔻 Download solution packages
    continueOnError: true
    inputs:
      buildType: current
      artifactName: slnPackages-${{ parameters.BuildConfiguration }}
      targetPath: $(Build.SourcesDirectory)/packages

  - ${{ if eq(parameters.LangVersion, '6') }}:
    - task: DownloadPipelineArtifact@2
      displayName: 🔻 Download build output
      continueOnError: true
      inputs:
        buildType: current
        artifactName: buildTest-cs${{ parameters.LangVersion }}-${{ parameters.BuildConfiguration }}
        targetPath: $(Build.SourcesDirectory)/StyleCop.Analyzers/StyleCop.Analyzers.Test/bin

  - ${{ if ne(parameters.LangVersion, '6') }}:
    - task: DownloadPipelineArtifact@2
      displayName: 🔻 Download build output
      continueOnError: true
      inputs:
        buildType: current
        artifactName: buildTest-cs${{ parameters.LangVersion }}-${{ parameters.BuildConfiguration }}
        targetPath: $(Build.SourcesDirectory)/StyleCop.Analyzers/StyleCop.Analyzers.Test.CSharp${{ parameters.LangVersion }}/bin

  - task: PowerShell@2
    displayName: 'Run tests'
    timeoutInMinutes: 20
    inputs:
      workingDirectory: '$(Build.SourcesDirectory)/build'
      targetType: inline
      script: |
        $results_dir = "TestResults"
        $coverage_dir = "coverage"
        New-Item -ItemType Directory -Force -Path $results_dir | Out-Null
        New-Item -ItemType Directory -Force -Path $coverage_dir | Out-Null

        $project_name = If ('${{ parameters.LangVersion }}' -Eq '6') { "StyleCop.Analyzers.Test" } Else { "StyleCop.Analyzers.Test.CSharp${{ parameters.LangVersion }}" }
        $project_path = "..\StyleCop.Analyzers\$project_name\$project_name.csproj"
        $trx_name = "StyleCopAnalyzers.CSharp${{ parameters.LangVersion }}.trx"

        dotnet test $project_path `
          --framework "${{ parameters.FrameworkVersion }}" `
          --configuration "${{ parameters.BuildConfiguration }}" `
          --no-build `
          --settings ".\coverlet.runsettings" `
          --results-directory $results_dir `
          --logger "trx;LogFileName=$trx_name" `
          --collect:"XPlat Code Coverage"

        $coverage_file = Get-ChildItem -Path $results_dir -Recurse -Filter "coverage.cobertura.xml" -ErrorAction SilentlyContinue | Select-Object -First 1
        if (-not $coverage_file) {
          Write-Error "Coverage file not found in $results_dir"
          exit 1
        }

        Copy-Item $coverage_file.FullName "$coverage_dir\OpenCover.StyleCopAnalyzers.CSharp${{ parameters.LangVersion }}.xml" -Force

  - task: PublishTestResults@2
    displayName: 📢 Publish test results
    condition: always()
    inputs:
      testResultsFormat: VSTest
      testResultsFiles: 'build/TestResults/**/*.trx'
      mergeTestResults: true
      testRunTitle: 'C# ${{ parameters.LangVersion }} ${{ parameters.BuildConfiguration }}'

  - ${{ if eq(parameters.BuildConfiguration, 'Debug') }}:
    - task: PublishPipelineArtifact@1
      displayName: Publish code coverage
      inputs:
        targetPath: $(Build.SourcesDirectory)/build/coverage
        artifact: coverageResults-cs${{ parameters.LangVersion }}
